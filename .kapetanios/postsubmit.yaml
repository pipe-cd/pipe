version: v1
kind: Build
spec:
  postsubmits:
  - name: push-images
    timeout: 30m
    machine:
      resource: medium
    dockerAuth:
      secret:
        name: container_registry_service_account
        type: PROJECT
    branches:
      - master
    steps:
    - description: Push service images
      runner: gcr.io/pipecd/runner:1.0.0
      commands:
        - bazelisk --output_base=/workspace/bazel_out run --config=ci --config=linux --config=stamping //cmd:push_images
      secrets:
      - name: bazel_cache_service_account
        type: PROJECT

  - name: publish-piped-linux
    timeout: 30m
    machine:
      resource: medium
    dockerAuth:
      secret:
        name: container_registry_service_account
        type: PROJECT
    skipBranches:
      - "*"
    steps:
    - description: Build piped
      runner: gcr.io/pipecd/runner:1.0.0
      commands:
        - bazelisk --output_base=/workspace/bazel_out build --config=ci --config=linux //:copy_piped
      secrets:
      - name: bazel_cache_service_account
        type: PROJECT

  - name: publish-piped-darwin
    timeout: 30m
    machine:
      resource: medium
    dockerAuth:
      secret:
        name: container_registry_service_account
        type: PROJECT
    skipBranches:
      - "*"
    steps:
    - description: Build piped
      runner: gcr.io/pipecd/runner:1.0.0
      commands:
        - bazelisk --output_base=/workspace/bazel_out build --config=ci --config=darwin //:copy_piped
      secrets:
      - name: bazel_cache_service_account
        type: PROJECT
